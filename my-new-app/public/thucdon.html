<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Th·ª±c ƒë∆°n - Jollibee Clone</title>

    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f7f7f7;
      }

      /* HEADER */
      header {
        background: #d6001c;
        padding: 15px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
      }
      header .logo {
        font-size: 28px;
        font-weight: bold;
      }
      header nav a {
        color: white;
        margin-left: 25px;
        text-decoration: none;
        font-size: 18px;
      }

      #cart-btn {
        background: yellow;
        padding: 6px 12px;
        border-radius: 6px;
        color: black !important;
        font-weight: bold;
      }

      /* CATEGORY BAR */
      .category-bar {
        background: #fff;
        padding: 15px 0;
        display: flex;
        justify-content: center;
        gap: 20px;
        border-bottom: 1px solid #ddd;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .category-item {
        padding: 10px 18px;
        background: #ffe6e8;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        border: 1px solid #d6001c;
      }
      .category-item:hover,
      .category-item.active {
        background: #d6001c;
        color: white;
      }

      /* PRODUCT */
      .section-block {
        padding: 30px 40px;
        max-width: 1200px;
        margin: auto;
      }
      .section-title {
        font-size: 26px;
        font-weight: bold;
        color: #b30015;
        margin-bottom: 15px;
      }

      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 20px;
      }
      .product-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        transition: 0.2s;
        text-align: center;
      }
      .product-card:hover {
        transform: translateY(-4px);
      }
      .product-image {
        width: 100%;
        height: 160px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      .product-name {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .product-price {
        font-size: 16px;
        color: #d6001c;
        margin-bottom: 10px;
      }

      .btn-cart {
        background: #d6001c;
        color: white;
        padding: 8px 14px;
        font-size: 14px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
      }
      .btn-cart:hover {
        background: #a00014;
      }

      footer {
        margin-top: 40px;
        padding: 20px;
        background: #d6001c;
        color: white;
        text-align: center;
      }

      /* Toast th√¥ng b√°o */
      .toast {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 230, 0, 0.95);
        color: #000;
        padding: 8px 14px; /* Nh·ªè h∆°n */
        font-size: 11px; /* Ch·ªØ nh·ªè l·∫°i */
        border-radius: 6px;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.4s ease;
        pointer-events: none;
        max-width: 200px; /* Gi·ªõi h·∫°n chi·ªÅu ngang */
        text-align: center; /* CƒÉn gi·ªØa n·ªôi dung */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      .toast.show {
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="logo">Jollibee Clone</div>
      <nav>
        <a href="index.html">Trang ch·ªß</a>
        <a href="thucdon.html">Th·ª±c ƒë∆°n</a>
        <a href="#">Khuy·∫øn m√£i</a>
        <a href="#">Li√™n h·ªá</a>
        <a href="theodoi.html">Theo d√µi ƒë∆°n h√†ng</a>

        <a id="cart-btn" href="giohang.html"
          >üõí Gi·ªè h√†ng (<span id="cart-count">0</span>)</a
        >

        <span id="user-area" style="margin-left: 20px"></span>
      </nav>
    </header>

    <!-- CATEGORY BAR -->
    <div class="category-bar" id="category-bar">ƒêang t·∫£i danh m·ª•c...</div>

    <!-- COMBO -->
    <section class="section-block">
      <div class="section-title">Combo ∆∞u ƒë√£i</div>
      <div class="product-grid" id="combo-grid"></div>
    </section>

    <!-- S·∫¢N PH·∫®M THEO DANH M·ª§C -->
    <section class="section-block">
      <div class="section-title">Danh s√°ch s·∫£n ph·∫©m</div>
      <div class="product-grid" id="product-grid"></div>
    </section>

    <footer>¬© 2025 Jollibee Clone</footer>

    <script>
      // ==================== TOAST MESSAGE ====================
      function showToast(message) {
        // T·∫°o div
        let toast = document.createElement("div");
        toast.className = "toast";
        toast.innerText = message;

        document.body.appendChild(toast);

        // Hi·ªán toast
        setTimeout(() => {
          toast.classList.add("show");
        }, 50);

        // 2 gi√¢y sau th√¨ m·ªù d·∫ßn v√† x√≥a b·ªè
        setTimeout(() => {
          toast.classList.remove("show");

          setTimeout(() => {
            toast.remove();
          }, 500);
        }, 2000);
      }

      /* ======================================
          üü¢ HI·ªÇN TH·ªä USER
       ====================================== */
      function loadUser() {
        const userArea = document.getElementById("user-area");
        const user = localStorage.getItem("user");

        if (!user) {
          userArea.innerHTML = `<a href="login.html" style="color:yellow;">ƒêƒÉng nh·∫≠p</a>`;
          return;
        }

        const u = JSON.parse(user);
        userArea.innerHTML = `
          Xin ch√†o, <b>${u.hoTen || u.username}</b> |
          <a href="#" onclick="logout()" style="color:yellow;">ƒêƒÉng xu·∫•t</a>
        `;
      }
      function logout() {
        localStorage.removeItem("user");
        loadUser();
      }
      loadUser();

      /* ======================================
          üõí GI·ªé H√ÄNG ‚Äì LOCAL STORAGE
       ====================================== */
      async function addToCart(sp) {
        try {
          const user = JSON.parse(localStorage.getItem("user"));
          if (!user) {
            alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m v√†o gi·ªè h√†ng");
            window.location.href = "login.html";
            return;
          }

          const MaUser = user.maNguoiDung;
          const MaGioHang = await getOrCreateCart(MaUser);

          // X√°c ƒë·ªãnh LoaiSanPham, MaSanPham ho·∫∑c MaCombo
          let payload = {
            MaGioHang,
            LoaiSanPham: sp.id.startsWith("C") ? "combo" : "sanpham", // gi·∫£ s·ª≠ combo c√≥ id b·∫Øt ƒë·∫ßu 'C'
            SoLuong: 1,
          };
          if (payload.LoaiSanPham === "combo") {
            payload.MaCombo = sp.id;
          } else {
            payload.MaSanPham = sp.id;
          }

          const res = await fetch("http://localhost:5000/api/giohang/add", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || "L·ªói th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng");
          }

          showToast("Th√™m v√†o gi·ªè h√†ng th√†nh c√¥ng!");

          // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng gi·ªè h√†ng hi·ªÉn th·ªã
          updateCartCount();
        } catch (error) {
          alert(error.message);
        }
      }

      async function getOrCreateCart(maUser) {
        let res = await fetch(
          `http://localhost:5000/api/giohang/user/${maUser}`
        );
        if (res.status === 404) {
          // Ch∆∞a c√≥ gi·ªè h√†ng -> t·∫°o m·ªõi
          const resCreate = await fetch(
            `http://localhost:5000/api/giohang/user/${maUser}`,
            {
              method: "POST",
            }
          );
          if (!resCreate.ok) throw new Error("Kh√¥ng th·ªÉ t·∫°o gi·ªè h√†ng");
          const dataCreate = await resCreate.json();
          // Tr·∫£ v·ªÅ id gi·ªè h√†ng m·ªõi t·∫°o
          return dataCreate.giohang.MaGioHang;
        }
        if (!res.ok) throw new Error("L·ªói l·∫•y gi·ªè h√†ng");
        const data = await res.json();
        return data.giohang.MaGioHang;
      }

      async function updateCartCount() {
        const user = JSON.parse(localStorage.getItem("user"));
        const cartCount = document.getElementById("cart-count");

        if (!user) {
          cartCount.innerText = 0;
          return;
        }

        try {
          const res = await fetch(
            `http://localhost:5000/api/giohang/user/${user.maNguoiDung}`
          );

          if (!res.ok) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c gi·ªè h√†ng");

          const data = await res.json();

          // data.chiTiet l√† danh s√°ch sp trong gi·ªè
          const total = data.chiTiet.reduce(
            (sum, item) => sum + item.SoLuong,
            0
          );

          cartCount.innerText = total;
        } catch (err) {
          console.error("L·ªói load cart count:", err);
          cartCount.innerText = 0;
        }
      }

      // G·ªçi khi t·∫£i trang
      updateCartCount();

      /* ======================================
          üü° LOAD DANH M·ª§C
       ====================================== */
      async function loadDanhMuc() {
        const bar = document.getElementById("category-bar");

        const res = await fetch("http://localhost:5000/api/danhmuc");
        const data = await res.json();

        bar.innerHTML = `<div class="category-item active" onclick="filterProduct('all', this)">T·∫•t c·∫£</div>`;

        data.forEach((dm) => {
          bar.innerHTML += `
            <div class="category-item" onclick="filterProduct('${dm.MaDanhMuc}', this)">
              ${dm.TenDanhMuc}
            </div>
          `;
        });
      }

      /* ======================================
          üî¥ LOAD COMBO
       ====================================== */
      async function loadCombo() {
        const grid = document.getElementById("combo-grid");

        const res = await fetch("http://localhost:5000/api/combo");
        const data = await res.json();

        grid.innerHTML = "";
        data.forEach((cb) => {
          grid.innerHTML += `
            <div class="product-card">
              <img src="images/${cb.HinhAnh}" class="product-image">
              <div class="product-name">${cb.TenCombo}</div>
              <div class="product-price">${Number(
                cb.GiaCombo
              ).toLocaleString()}‚Ç´</div>
              <button class="btn-cart" onclick='addToCart({
                  id: "${cb.MaCombo}",
                  name: "${cb.TenCombo}",
                  price: ${cb.GiaCombo},
                  img: "${cb.HinhAnh}"
              })'>üõí Th√™m v√†o gi·ªè</button>
            </div>
          `;
        });
      }

      /* ======================================
          üîµ LOAD S·∫¢N PH·∫®M
       ====================================== */
      let allProducts = [];

      async function loadProducts() {
        const grid = document.getElementById("product-grid");
        const res = await fetch("http://localhost:5000/api/sanpham");
        allProducts = await res.json();

        showProducts(allProducts);
      }

      function showProducts(list) {
        const grid = document.getElementById("product-grid");
        grid.innerHTML = "";

        list.forEach((sp) => {
          grid.innerHTML += `
            <div class="product-card">
              <img src="images/${sp.HinhAnh}" class="product-image">
              <div class="product-name">${sp.TenSanPham}</div>
              <div class="product-price">${Number(
                sp.Gia
              ).toLocaleString()}‚Ç´</div>

              <button class="btn-cart" onclick='addToCart({
                  id: "${sp.MaSanPham}",
                  name: "${sp.TenSanPham}",
                  price: ${sp.Gia},
                  img: "${sp.HinhAnh}"
              })'>üõí Th√™m v√†o gi·ªè</button>
            </div>
          `;
        });
      }

      /* ======================================
          üü£ FILTER DANH M·ª§C
       ====================================== */
      function filterProduct(maDM, element) {
        document
          .querySelectorAll(".category-item")
          .forEach((e) => e.classList.remove("active"));
        element.classList.add("active");

        if (maDM === "all") return showProducts(allProducts);

        const filtered = allProducts.filter((sp) => sp.MaDanhMuc === maDM);
        showProducts(filtered);
      }

      // CH·∫†Y T·∫§T C·∫¢
      loadDanhMuc();
      loadCombo();
      loadProducts();
    </script>
  </body>
</html>
