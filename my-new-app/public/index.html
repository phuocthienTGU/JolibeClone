<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jollibee UI</title>

    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f7f7f7;
      }

      /* HEADER */
      header {
        background: #d6001c;
        padding: 15px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
      }
      header .logo {
        font-size: 28px;
        font-weight: bold;
      }
      header nav a {
        color: white;
        margin-left: 25px;
        text-decoration: none;
        font-size: 18px;
      }

      /* BANNER */
      .banner {
        width: 100%;
        height: 360px;
        background: #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 32px;
        color: #333;
      }

      /* PRODUCT */
      .product-section {
        padding: 40px;
        max-width: 1200px;
        margin: auto;
      }
      .product-title {
        font-size: 28px;
        margin-bottom: 20px;
        font-weight: bold;
        color: #b30015;
      }
      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 20px;
      }

      .product-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
        padding: 15px;
        text-align: center;
        transition: 0.2s;
      }
      .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.18);
      }
      .product-image {
        width: 100%;
        height: 160px;
        object-fit: cover;
        border-radius: 6px;
        margin-bottom: 10px;
      }
      .product-name {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 8px;
      }
      .product-price {
        font-size: 16px;
        color: #d6001c;
        margin-bottom: 12px;
      }
      .btn-buy {
        padding: 10px 14px;
        background: #d6001c;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      footer {
        margin-top: 40px;
        padding: 20px;
        background: #d6001c;
        color: white;
        text-align: center;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="logo">Jollibee Clone</div>
      <nav>
        <a href="index.html">Trang ch·ªß</a>
        <a href="thucdon.html">Th·ª±c ƒë∆°n</a>
        <a href="#">Khuy·∫øn m√£i</a>
        <a href="#">Li√™n h·ªá</a>
        <a href="theodoi.html">Theo d√µi ƒë∆°n h√†ng</a>
        <a
          id="cart-btn"
          href="giohang.html"
          style="
            background: yellow;
            padding: 6px 12px;
            border-radius: 6px;
            color: black !important;
            font-weight: bold;
            margin-left: 15px;
          "
        >
          üõí Gi·ªè h√†ng (<span id="cart-count">0</span>)
        </a>

        <!-- Khu ƒëƒÉng nh·∫≠p -->
        <span id="user-area" style="margin-left: 20px; font-size: 18px">
          <!-- n·ªôi dung s·∫Ω t·ª± thay ƒë·ªïi b·∫±ng JavaScript -->
        </span>
      </nav>
    </header>

    <div class="banner">Banner (ch√®n ·∫£nh sau)</div>

    <section class="product-section">
      <div class="product-title">M√≥n ƒÉn n·ªïi b·∫≠t</div>
      <div class="product-grid" id="product-grid">
        <!-- S·∫£n ph·∫©m t·ª´ DB s·∫Ω ƒë∆∞·ª£c load v√†o ƒë√¢y -->
      </div>
    </section>

    <footer>¬© 2025 Jollibee Clone - Giao di·ªán k·∫øt n·ªëi CSDL</footer>

    <script>
      function loadUser() {
        const userArea = document.getElementById("user-area");
        const user = localStorage.getItem("user");

        if (!user) {
          userArea.innerHTML = `
        <a href="login.html" style="color: yellow;">ƒêƒÉng nh·∫≠p</a>
      `;
          return;
        }

        const u = JSON.parse(user);
        const name = u.hoTen || u.username || u.ten || null;

        if (name) {
          userArea.innerHTML = `
        Xin ch√†o, <b>${name}</b> |
        <a href="#" onclick="logout()" style="color: yellow;">ƒêƒÉng xu·∫•t</a>
      `;
        }
      }

      function logout() {
        localStorage.removeItem("user");
        alert("ƒê√£ ƒëƒÉng xu·∫•t!");
        loadUser();
      }
      loadUser();

      /* ================== GI·ªé H√ÄNG ================== */

      async function getOrCreateCart(maUser) {
        let res = await fetch(
          `http://localhost:5000/api/giohang/user/${maUser}`
        );

        if (res.status === 404) {
          const createRes = await fetch(
            `http://localhost:5000/api/giohang/user/${maUser}`,
            { method: "POST" }
          );
          const data = await createRes.json();
          return data.giohang.MaGioHang;
        }

        const data = await res.json();
        return data.giohang.MaGioHang;
      }

      async function addToCart(sp) {
        try {
          const user = JSON.parse(localStorage.getItem("user"));
          if (!user) {
            alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m v√†o gi·ªè!");
            window.location.href = "login.html";
            return;
          }

          const MaUser = user.maNguoiDung;
          const MaGioHang = await getOrCreateCart(MaUser);

          const payload = {
            MaGioHang,
            LoaiSanPham: "sanpham",
            MaSanPham: sp.id,
            SoLuong: 1,
          };

          const res = await fetch("http://localhost:5000/api/giohang/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await res.json();
          if (!res.ok) throw new Error(result.error || "L·ªói th√™m gi·ªè h√†ng");

          alert("‚úÖ ƒê√£ th√™m v√†o gi·ªè h√†ng!");
          alert("‚úÖ ƒê√£ th√™m v√†o gi·ªè!");
          updateCartCount();
        } catch (err) {
          alert("‚ùå " + err.message);
        }
      }

      /* ================== LOAD S·∫¢N PH·∫®M + N√öT GI·ªé H√ÄNG ================== */

      async function loadProducts() {
        const grid = document.getElementById("product-grid");
        grid.innerHTML = "ƒêang t·∫£i s·∫£n ph·∫©m...";

        try {
          const res = await fetch("http://localhost:5000/api/sanpham");
          const data = await res.json();

          grid.innerHTML = "";

          data.forEach((sp) => {
            const card = `
          <div class="product-card">
            <img src="images/${sp.HinhAnh}" class="product-image" alt="">
            <div class="product-name">${sp.TenSanPham}</div>
            <div class="product-price">${Number(sp.Gia).toLocaleString()}‚Ç´</div>

            <button class="btn-buy" onclick='addToCart({
              id: "${sp.MaSanPham}",
              name: "${sp.TenSanPham}",
              price: ${sp.Gia},
              img: "${sp.HinhAnh}"
            })'>üõí Th√™m v√†o gi·ªè</button>
          </div>
        `;
            grid.innerHTML += card;
          });
        } catch (err) {
          grid.innerHTML = "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu!";
          console.error(err);
        }
      }

      loadProducts();

      async function updateCartCount() {
        const user = JSON.parse(localStorage.getItem("user"));
        const cartCount = document.getElementById("cart-count");

        if (!user) {
          cartCount.innerText = 0;
          return;
        }

        try {
          const res = await fetch(
            `http://localhost:5000/api/giohang/user/${user.maNguoiDung}`
          );

          if (!res.ok) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c gi·ªè h√†ng");

          const data = await res.json();

          // data.chiTiet l√† danh s√°ch sp trong gi·ªè
          const total = data.chiTiet.reduce(
            (sum, item) => sum + item.SoLuong,
            0
          );

          cartCount.innerText = total;
        } catch (err) {
          console.error("L·ªói load cart count:", err);
          cartCount.innerText = 0;
        }
      }

      // G·ªçi khi t·∫£i trang
      updateCartCount();
    </script>
  </body>
</html>
